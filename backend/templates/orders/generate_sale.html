{% extends 'base/base.html' %}

{% block title %}Generar Venta - Pedido {{ order.order_number }}{% endblock %}
{% block page_title %}Generar Venta{% endblock %}
{% block mobile_title %}Generar Venta{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Generar Venta desde Pedido {{ order.order_number }}</h5>
      </div>
      <div class="card-body">
        <div class="alert alert-info">
          <strong>Cliente:</strong> {{ order.customer.name }}<br>
          <strong>Total del Pedido:</strong> ₲ <span id="order-total" data-total="{{ order.total }}">{{ order.total|floatformat:0 }}</span>
        </div>

        <form method="POST">
          {% csrf_token %}
          
          <div class="mb-3">
            <label class="form-label">Método de Pago *</label>
            <select name="payment_method" class="form-select" required id="payment_method">
              <option value="">Seleccione...</option>
              <option value="cash">Efectivo</option>
              <option value="pix">PIX</option>
              <option value="card">Tarjeta Débito/Crédito</option>
              <option value="transfer">Transferencia</option>
              <option value="credit">Fiado/Crédito</option>
            </select>
          </div>

          <!-- EFECTIVO -->
          <div id="cash-fields" style="display: none;">
            <div class="mb-3">
              <label class="form-label">Moneda *</label>
              <select name="currency" class="form-select">
                <option value="PYG">Guaraníes (₲)</option>
                <option value="USD">Dólares ($)</option>
                <option value="BRL">Reales (R$)</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Monto Recibido *</label>
              <input type="number" name="amount_received" id="amount_received" 
                     class="form-control form-control-lg" 
                     placeholder="Ej: 250000"
                     step="1000">
              <small class="text-muted">Dinero que entregó el cliente</small>
            </div>

            <div class="alert alert-success" id="change-display" style="display: none;">
              <div class="d-flex justify-content-between align-items-center">
                <strong>Vuelto:</strong>
                <h4 class="mb-0" id="change-amount">₲ 0</h4>
              </div>
            </div>
            
            <div class="alert alert-danger" id="insufficient-display" style="display: none;">
              <strong>⚠️ Monto insuficiente</strong>
            </div>
          </div>

          <!-- OTROS MÉTODOS -->
          <div id="other-fields" style="display: none;">
            <div class="mb-3">
              <label class="form-label">Moneda *</label>
              <select name="currency_other" class="form-select">
                <option value="PYG">Guaraníes (₲)</option>
                <option value="USD">Dólares ($)</option>
                <option value="BRL">Reales (R$)</option>
              </select>
            </div>
          </div>

          <!-- CRÉDITO -->
          <div id="credit-fields" style="display: none;">
            <div class="mb-3">
              <label class="form-label">Número de Cuotas *</label>
              <select name="installments" class="form-select">
                <option value="1">1 cuota</option>
                <option value="2">2 cuotas</option>
                <option value="3">3 cuotas</option>
                <option value="4">4 cuotas</option>
                <option value="6">6 cuotas</option>
                <option value="12">12 cuotas</option>
              </select>
            </div>
          </div>

          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            Esta acción creará una venta registrada y descontará el stock del inventario.
          </div>

          <div class="d-flex justify-content-between">
            <a href="{% url 'orders:detail' order.pk %}" class="btn btn-secondary">
              Cancelar
            </a>
            <button type="submit" class="btn btn-success">
              <i class="bi bi-check-circle"></i> Generar Venta
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-header">
        <strong>Productos del Pedido</strong>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <thead class="table-light">
              <tr>
                <th>Producto</th>
                <th class="text-end">Cant.</th>
                <th class="text-end">Precio</th>
                <th class="text-end">Total</th>
              </tr>
            </thead>
            <tbody>
              {% for item in order.items.all %}
              <tr>
                <td>{{ item.product.name }}</td>
                <td class="text-end">{{ item.quantity }}</td>
                <td class="text-end">₲ {{ item.unit_price|floatformat:0 }}</td>
                <td class="text-end">₲ {{ item.total|floatformat:0 }}</td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr>
                <th colspan="3" class="text-end">Total:</th>
                <th class="text-end">₲ {{ order.total|floatformat:0 }}</th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Obtener el total desde el atributo data-total
  var orderTotal = parseFloat(document.getElementById('order-total').getAttribute('data-total'));
  
  var cashFields = document.getElementById('cash-fields');
  var otherFields = document.getElementById('other-fields');
  var creditFields = document.getElementById('credit-fields');
  var paymentMethod = document.getElementById('payment_method');
  var amountReceived = document.getElementById('amount_received');
  var changeAmount = document.getElementById('change-amount');
  var changeDisplay = document.getElementById('change-display');
  var insufficientDisplay = document.getElementById('insufficient-display');

  // Cambiar según método
  paymentMethod.addEventListener('change', function() {
    cashFields.style.display = 'none';
    otherFields.style.display = 'none';
    creditFields.style.display = 'none';
    
    if (this.value === 'cash') {
      cashFields.style.display = 'block';
    } else if (this.value === 'credit') {
      creditFields.style.display = 'block';
    } else if (this.value) {
      otherFields.style.display = 'block';
    }
  });

  // Calcular vuelto
  amountReceived.addEventListener('input', function() {
    var received = parseFloat(this.value) || 0;
    var change = received - orderTotal;
    
    if (received === 0) {
      changeDisplay.style.display = 'none';
      insufficientDisplay.style.display = 'none';
    } else if (change < 0) {
      changeDisplay.style.display = 'none';
      insufficientDisplay.style.display = 'block';
    } else {
      insufficientDisplay.style.display = 'none';
      changeDisplay.style.display = 'block';
      changeAmount.textContent = '₲ ' + Math.round(change).toLocaleString('es-PY');
    }
  });
});
</script>
{% endblock %}
