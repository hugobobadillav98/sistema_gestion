{% extends 'base/base.html' %}




{% block title %}Presupuesto {{ quote.quote_number }}{% endblock %}
{% block page_title %}Presupuesto {{ quote.quote_number }}{% endblock %}
{% block mobile_title %}Presupuesto{% endblock %}




{% block content %}
<div class="d-flex justify-content-between mb-3">
  <div>
    <h5 class="mb-1">
      {% if quote.customer %}
        {{ quote.customer.name }}
      {% else %}
        <span class="text-muted">Cliente General</span>
      {% endif %}
    </h5>
    <small class="text-muted">
      Emisión: {{ quote.issue_date|date:"d/m/Y" }} ·
      Válido hasta: {{ quote.valid_until|date:"d/m/Y" }}
    </small>
  </div>
  <div class="text-end">
    <span class="badge
      {% if quote.status == 'draft' %}bg-secondary
      {% elif quote.status == 'sent' %}bg-info
      {% elif quote.status == 'approved' %}bg-success
      {% elif quote.status == 'rejected' %}bg-danger
      {% else %}bg-warning{% endif %}">
      {{ quote.get_status_display }}
    </span>
    <div class="mt-2">
      <a href="{% url 'quotes:list' %}" class="btn btn-sm btn-outline-secondary">
        Volver
      </a>
      {% if quote.can_be_edited %}
      <a href="{% url 'quotes:edit' quote.pk %}" class="btn btn-sm btn-primary">
        Editar
      </a>
      {% endif %}
    </div>
  </div>
</div>


<!-- Advertencia: Cliente General -->
{% if not quote.customer %}
<div class="alert alert-warning d-flex justify-content-between align-items-center mb-3">
  <div>
    <i class="bi bi-exclamation-triangle"></i>
    <strong>Presupuesto Genérico</strong><br>
    <small>
      Este presupuesto no tiene un cliente específico asignado. 
      No podrá convertirse en pedido sin asignar un cliente.
    </small>
  </div>
  <a href="{% url 'quotes:assign_customer' quote.pk %}" class="btn btn-sm btn-warning">
    <i class="bi bi-person-plus"></i> Asignar Cliente
  </a>
</div>
{% endif %}


<!-- Botones de acciones según estado -->
{% if quote.status == 'draft' and items %}
<div class="alert alert-info d-flex justify-content-between align-items-center mb-3">
  <span>Presupuesto listo para enviar al cliente</span>
  <a href="{% url 'quotes:send' quote.pk %}" class="btn btn-sm btn-info">
    <i class="bi bi-send"></i> Marcar como Enviado
  </a>
</div>
{% endif %}



{% if quote.status == 'sent' %}
<div class="alert alert-warning d-flex justify-content-between align-items-center mb-3">
  <span>¿El cliente respondió?</span>
  <div>
    <a href="{% url 'quotes:approve' quote.pk %}" class="btn btn-sm btn-success me-2">
      <i class="bi bi-check-circle"></i> Aprobar
    </a>
    <a href="{% url 'quotes:reject' quote.pk %}" class="btn btn-sm btn-danger">
      <i class="bi bi-x-circle"></i> Rechazar
    </a>
  </div>
</div>
{% endif %}



{% if quote.status == 'approved' and not quote.converted_to_order %}
<div class="alert alert-success d-flex justify-content-between align-items-center mb-3">
  <span><i class="bi bi-check-circle-fill"></i> Presupuesto aprobado</span>
  <a href="{% url 'quotes:convert_to_order' quote.pk %}" class="btn btn-sm btn-success">
    <i class="bi bi-cart-plus"></i> Convertir a Pedido
  </a>
</div>
{% endif %}



{% if quote.status == 'rejected' %}
<div class="alert alert-danger mb-3">
  <i class="bi bi-x-circle-fill"></i> Este presupuesto fue rechazado por el cliente.
</div>
{% endif %}



{% if quote.converted_to_order %}
<div class="alert alert-secondary mb-3">
  <i class="bi bi-check2-all"></i> Este presupuesto ya fue convertido a pedido el {{ quote.converted_date|date:"d/m/Y" }}.
</div>
{% endif %}



<div class="card mb-3">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table mb-0">
        <thead class="table-light">
          <tr>
            <th>Producto</th>
            <th class="text-end">Cant.</th>
            <th class="text-end">Precio (c/IVA)</th>
            <th class="text-end">Base</th>
            <th class="text-end">IVA</th>
            <th class="text-end">Total</th>
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
          <tr>
            <td>{{ item.product.name }}</td>
            <td class="text-end">{{ item.quantity }}</td>
            <td class="text-end">₲ {{ item.unit_price|floatformat:0 }}</td>
            <td class="text-end">₲ {{ item.base_amount|floatformat:0 }}</td>
            <td class="text-end">₲ {{ item.tax_amount|floatformat:0 }}</td>
            <td class="text-end">₲ {{ item.total|floatformat:0 }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="text-center py-3 text-muted">
              Sin productos aún.
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <th colspan="4"></th>
            <th class="text-end">Subtotal:</th>
            <th class="text-end">₲ {{ quote.subtotal|floatformat:0 }}</th>
          </tr>
          <tr>
            <th colspan="4"></th>
            <th class="text-end">IVA:</th>
            <th class="text-end">₲ {{ quote.total_tax|floatformat:0 }}</th>
          </tr>
          <tr>
            <th colspan="4"></th>
            <th class="text-end">Total:</th>
            <th class="text-end">₲ {{ quote.total|floatformat:0 }}</th>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>
{% endblock %}
