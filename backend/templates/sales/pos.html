{% extends 'base/base.html' %}

{% block title %}POS - Punto de Venta{% endblock %}

{% block page_title %}Punto de Venta{% endblock %}

{% block mobile_title %}POS{% endblock %}

{% block extra_css %}
<style>
    .product-card {
        cursor: pointer;
        transition: all 0.2s;
    }
    .product-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .cart-item {
        border-bottom: 1px solid #dee2e6;
        padding: 10px 0;
    }
    .product-stock-low {
        color: #dc3545;
    }
    .product-stock-ok {
        color: #28a745;
    }
    .currency-btn {
        font-size: 0.85rem;
        padding: 0.5rem;
    }
    .currency-btn.active {
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div x-data="posData()">
    <div class="row">
        <!-- Products Section -->
        <div class="col-lg-8">
            <div class="card mb-3">
                <div class="card-body">
                    <!-- Search and Filters -->
                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <input 
                                type="text" 
                                class="form-control" 
                                placeholder="Buscar producto por nombre o c√≥digo..."
                                x-model="searchQuery"
                                @input="filterProducts()"
                            >
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" x-model="selectedCategory" @change="filterProducts()">
                                <option value="">Todas las categor√≠as</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-secondary w-100" @click="clearFilters()">
                                <i class="bi bi-x-circle"></i> Limpiar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Products Grid -->
                    <div class="row g-2" style="max-height: 600px; overflow-y: auto;">
                        <template x-for="product in filteredProducts" :key="product.id">
                            <div class="col-md-4 col-sm-6">
                                <div class="card product-card h-100" @click="addToCart(product)">
                                    <div class="card-body">
                                        <h6 class="card-title" x-text="product.name"></h6>
                                        <p class="card-text mb-1">
                                            <small class="text-muted" x-text="product.code"></small>
                                        </p>
                                        
                                        <!-- Precio principal en Guaran√≠es -->
                                        <p class="card-text mb-1">
                                            <strong class="text-success">‚Ç≤ <span x-text="formatNumber(product.sale_price)"></span></strong>
                                        </p>
                                        
                                        <!-- Precios equivalentes en otras monedas -->
                                        <p class="card-text mb-1">
                                            <small class="text-muted">
                                                $ <span x-text="(product.sale_price / exchangeRates.USD).toFixed(2)"></span> USD
                                                |
                                                R$ <span x-text="(product.sale_price / exchangeRates.BRL).toFixed(2)"></span>
                                            </small>
                                        </p>
                                        
                                        <p class="card-text mb-0">
                                            <small>
                                                Stock: 
                                                <span :class="product.current_stock <= product.minimum_stock ? 'product-stock-low' : 'product-stock-ok'">
                                                    <span x-text="product.current_stock"></span>
                                                </span>
                                            </small>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Cart Section -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-basket"></i> Carrito</h5>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    <template x-if="cart.length === 0">
                        <p class="text-muted text-center">Carrito vac√≠o</p>
                    </template>
                    
                    <template x-for="(item, index) in cart" :key="index">
                        <div class="cart-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1" x-text="item.product.name"></h6>
                                    <small class="text-muted" x-text="item.product.code"></small>
                                </div>
                                <button 
                                    class="btn btn-sm btn-danger" 
                                    @click="removeFromCart(index)"
                                    type="button"
                                >
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            <div class="row g-2 mt-2">
                                <div class="col-4">
                                    <label class="form-label small">Cant.</label>
                                    <input 
                                        type="number" 
                                        class="form-control form-control-sm" 
                                        x-model.number="item.quantity"
                                        @input="updateTotals()"
                                        min="1"
                                        :max="item.product.current_stock"
                                    >
                                </div>
                                <div class="col-4">
                                    <label class="form-label small">Precio</label>
                                    <input 
                                        type="number" 
                                        class="form-control form-control-sm" 
                                        x-model.number="item.unit_price"
                                        @input="updateTotals()"
                                        min="0"
                                        disabled
                                    >
                                </div>
                                <div class="col-4">
                                    <label class="form-label small">Desc%</label>
                                    <input 
                                        type="number" 
                                        class="form-control form-control-sm" 
                                        x-model.number="item.discount"
                                        @input="updateTotals()"
                                        min="0"
                                        max="100"
                                    >
                                </div>
                            </div>
                            <div class="mt-2">
                                <strong>Subtotal: ‚Ç≤ <span x-text="formatNumber(item.subtotal)"></span></strong>
                            </div>
                        </div>
                    </template>
                </div>
                
                <div class="card-body border-top">
                    <!-- Customer Selection -->
                    <div class="mb-3">
                        <label class="form-label">Cliente (opcional)</label>
                        <select class="form-select" x-model="selectedCustomer">
                            <option value="">Cliente General</option>
                            {% for customer in customers %}
                            <option value="{{ customer.id }}">{{ customer.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Payment Method -->
                    <div class="mb-3">
                        <label class="form-label">M√©todo de Pago</label>
                        <select class="form-select" x-model="paymentMethod" @change="updatePaymentUI()">
                            <option value="cash">Efectivo</option>
                            <option value="card">Tarjeta D√©bito/Cr√©dito</option>
                            <option value="pix">PIX (Brasil)</option>
                            <option value="transfer">Transferencia Bancaria</option>
                            <option value="credit">Fiado/Cr√©dito</option>
                        </select>
                    </div>
                    
                    <!-- Fecha Prometida (solo para cr√©dito) -->
                    <div class="mb-3" x-show="paymentMethod === 'credit'">
                        <label class="form-label">
                            <i class="bi bi-calendar-event"></i> Fecha Prometida de Pago
                        </label>
                        <input 
                            type="date" 
                            class="form-control" 
                            x-model="promisedDate"
                            :min="new Date().toISOString().split('T')[0]"
                        >
                        <small class="text-muted">¬øCu√°ndo prometi√≥ pagar el cliente?</small>
                    </div>

                    <!-- Cuotas (solo para cr√©dito) -->
                    <div class="mb-3" x-show="paymentMethod === 'credit'">
                        <label class="form-label">
                            <i class="bi bi-credit-card"></i> N√∫mero de Cuotas
                        </label>
                        <select class="form-select" x-model.number="installments">
                            <option value="1">1 cuota (Pago √∫nico)</option>
                            <option value="2">2 cuotas</option>
                            <option value="3">3 cuotas</option>
                            <option value="4">4 cuotas</option>
                            <option value="6">6 cuotas</option>
                            <option value="12">12 cuotas</option>
                        </select>
                        <small class="text-muted">
                            <span x-show="installments > 1">
                                Monto por cuota: ‚Ç≤ <span x-text="formatNumber(total / installments)"></span>
                            </span>
                        </small>
                    </div>

                    <!-- Alerta si falta cliente en cr√©dito -->
                    <div class="alert alert-warning mb-3" x-show="paymentMethod === 'credit' && !selectedCustomer">
                        <small><i class="bi bi-exclamation-triangle"></i> Debe seleccionar un cliente para ventas a cr√©dito</small>
                    </div>
                    
                    <!-- Currency Selector (solo para efectivo y PIX) -->
                    <div class="mb-3" x-show="paymentMethod === 'cash' || paymentMethod === 'pix'">
                        <label class="form-label">Moneda de Pago</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="currency" id="curr-pyg" value="PYG" x-model="currencyPaid" @change="updateTotals()">
                            <label class="btn btn-outline-success currency-btn" for="curr-pyg">‚Ç≤ Guaran√≠es</label>
                            
                            <input type="radio" class="btn-check" name="currency" id="curr-usd" value="USD" x-model="currencyPaid" @change="updateTotals()">
                            <label class="btn btn-outline-primary currency-btn" for="curr-usd">$ D√≥lares</label>
                            
                            <input type="radio" class="btn-check" name="currency" id="curr-brl" value="BRL" x-model="currencyPaid" @change="updateTotals()">
                            <label class="btn btn-outline-info currency-btn" for="curr-brl">R$ Reales</label>
                        </div>
                    </div>
                    
                    <!-- PIX Reference -->
                    <div class="mb-3" x-show="paymentMethod === 'pix'">
                        <label class="form-label">ID Transacci√≥n PIX (opcional)</label>
                        <input type="text" class="form-control" x-model="pixReference" placeholder="E1234567890...">
                    </div>
                    
                    <!-- Totals -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Subtotal:</span>
                            <strong>‚Ç≤ <span x-text="formatNumber(subtotal)"></span></strong>
                        </div>
                        
                        <div class="d-flex justify-content-between mt-2">
                            <span>IVA:</span>
                            <strong>‚Ç≤ <span x-text="formatNumber(taxAmount)"></span></strong>
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <h5>Total (PYG):</h5>
                            <h5 class="text-success">‚Ç≤ <span x-text="formatNumber(total)"></span></h5>
                        </div>
                        
                        <!-- Total en moneda seleccionada -->
                        <div class="alert alert-info mb-0" x-show="currencyPaid !== 'PYG' && (paymentMethod === 'cash' || paymentMethod === 'pix')">
                            <div class="d-flex justify-content-between">
                                <strong>Total en <span x-text="currencyPaid"></span>:</strong>
                                <strong>
                                    <span x-text="getCurrencySymbol(currencyPaid)"></span>
                                    <span x-text="getConvertedTotal().toFixed(2)"></span>
                                </strong>
                            </div>
                            <small class="text-muted">
                                Tasa: 1 <span x-text="currencyPaid"></span> = ‚Ç≤ <span x-text="formatNumber(exchangeRates[currencyPaid])"></span>
                            </small>
                        </div>
                    </div>
                    
                    <!-- Paid Amount (para efectivo y PIX) -->
                    <div class="mb-3" x-show="paymentMethod === 'cash'">
                        <label class="form-label">
                            Monto Recibido (<span x-text="getCurrencySymbol(currencyPaid)"></span>)
                        </label>
                        <input 
                            type="number" 
                            class="form-control" 
                            x-model.number="paidAmount"
                            @input="calculateChange()"
                            placeholder="0.00"
                            step="0.01"
                        >
                        <template x-if="change > 0">
                            <div class="alert alert-success mt-2 mb-0">
                                <strong>Vuelto: <span x-text="getCurrencySymbol(currencyPaid)"></span> <span x-text="formatDecimal(change)"></span></strong>
                                <template x-if="currencyPaid !== 'PYG'">
                                    <div>
                                        <small>(‚Ç≤ <span x-text="formatNumber(changePYG)"></span>)</small>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template x-if="paidAmount > 0 && paidAmount < getConvertedTotal()">
                            <div class="alert alert-danger mt-2 mb-0">
                                <small>Falta: <span x-text="getCurrencySymbol(currencyPaid)"></span> <span x-text="formatDecimal(getConvertedTotal() - paidAmount)"></span></small>
                            </div>
                        </template>
                    </div>
                    
                    <!-- Actions -->
                    <div class="d-grid gap-2">
                        <button 
                            class="btn btn-success btn-lg" 
                            @click="processSale()"
                            :disabled="cart.length === 0 || !canProcessSale()"
                        >
                            <i class="bi bi-check-circle"></i> Procesar Venta
                        </button>
                        <button 
                            class="btn btn-outline-secondary" 
                            @click="clearCart()"
                            :disabled="cart.length === 0"
                        >
                            <i class="bi bi-x-circle"></i> Limpiar Carrito
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function posData() {
    return {
        // Products data
        products: [
            {% for product in products %}
            {
                id: '{{ product.id }}',
                code: '{{ product.code|escapejs }}',
                name: '{{ product.name|escapejs }}',
                sale_price: {{ product.sale_price|floatformat:0 }},
                current_stock: {{ product.current_stock|floatformat:0 }},
                minimum_stock: {{ product.minimum_stock|floatformat:0 }},
                category_id: {% if product.category %}'{{ product.category.id }}'{% else %}null{% endif %},
                tax_type: '{{ product.tax_type }}'
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        filteredProducts: [],
        
        // Cart
        cart: [],
        
        // Filters
        searchQuery: '',
        selectedCategory: '',
        
        // Customer & Payment
        selectedCustomer: '',
        paymentMethod: 'cash',
        currencyPaid: 'PYG',
        paidAmount: 0,
        pixReference: '',
        promisedDate: '',
        installments: 1,
        
        // Totals
        subtotal: 0,
        taxAmount: 0,
        total: 0,
        change: 0,
        changePYG: 0,
        
        // Exchange rates
        exchangeRates: {
            PYG: 1,
            USD: {{ exchange_rates.USD|default:7300 }},
            BRL: {{ exchange_rates.BRL|default:1450 }}
        },
        
        init() {
            this.filteredProducts = [...this.products];
            console.log('‚úÖ POS cargado:', this.products.length, 'productos');
            console.log('üí± Tasas:', this.exchangeRates);
        },
        
        formatNumber(num) {
            if (!num) return '0';
            return new Intl.NumberFormat('es-PY').format(Math.round(num));
        },
        
        formatDecimal(num) {
            if (!num) return '0.00';
            return num.toFixed(2);
        },
        
        getCurrencySymbol(currency) {
            const symbols = { PYG: '‚Ç≤', USD: '$', BRL: 'R$' };
            return symbols[currency] || '‚Ç≤';
        },
        
        getConvertedTotal() {
            if (this.currencyPaid === 'PYG') return this.total;
            return this.total / this.exchangeRates[this.currencyPaid];
        },
        
        filterProducts() {
            this.filteredProducts = this.products.filter(p => {
                const matchesSearch = !this.searchQuery || 
                    p.name.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
                    p.code.toLowerCase().includes(this.searchQuery.toLowerCase());
                    
                const matchesCategory = !this.selectedCategory || 
                    p.category_id === this.selectedCategory;
                    
                return matchesSearch && matchesCategory;
            });
        },
        
        clearFilters() {
            this.searchQuery = '';
            this.selectedCategory = '';
            this.filterProducts();
        },
        
        addToCart(product) {
            const existingItem = this.cart.find(item => item.product.id === product.id);
            
            if (existingItem) {
                if (existingItem.quantity < product.current_stock) {
                    existingItem.quantity++;
                } else {
                    alert('Stock insuficiente');
                    return;
                }
            } else {
                this.cart.push({
                    product: product,
                    quantity: 1,
                    unit_price: product.sale_price,
                    discount: 0,
                    subtotal: product.sale_price,
                    tax_type: product.tax_type
                });
            }
            
            this.updateTotals();
        },
        
        removeFromCart(index) {
            this.cart.splice(index, 1);
            this.updateTotals();
        },
        
        updateTotals() {
            this.subtotal = 0;
            
            this.cart.forEach(item => {
                const discountAmount = (item.unit_price * item.quantity) * (item.discount / 100);
                item.subtotal = (item.unit_price * item.quantity) - discountAmount;
                this.subtotal += item.subtotal;
            });
            
            let totalTax = 0;
            this.cart.forEach(item => {
                const itemTotal = item.subtotal;
                const taxType = item.tax_type || '10';
                
                let taxRate = 0;
                if (taxType === '10') taxRate = 0.10;
                else if (taxType === '5') taxRate = 0.05;
                
                if (taxRate > 0) {
                    const basePrice = itemTotal / (1 + taxRate);
                    const itemTax = itemTotal - basePrice;
                    totalTax += itemTax;
                }
            });
            
            this.total = this.subtotal;
            this.taxAmount = Math.round(totalTax);
            
            if (this.paymentMethod === 'cash' || this.paymentMethod === 'pix') {
                this.calculateChange();
            }
        },
        
        updatePaymentUI() {
            if (this.paymentMethod === 'card' || this.paymentMethod === 'transfer') {
                // Pagos digitales (tarjeta/transferencia): siempre PYG, monto exacto
                this.currencyPaid = 'PYG';
                this.paidAmount = this.total;
                this.change = 0;
                this.changePYG = 0;
            } else if (this.paymentMethod === 'pix') {
                // PIX: mantener la moneda seleccionada, monto exacto en esa moneda
                // NO cambiar currencyPaid aqu√≠
                this.paidAmount = this.getConvertedTotal();
                this.change = 0;
                this.changePYG = 0;
            } else if (this.paymentMethod === 'credit') {
                // Cr√©dito: no requiere pago inmediato
                this.currencyPaid = 'PYG';
                this.paidAmount = 0;
                this.change = 0;
                this.changePYG = 0;
            } else if (this.paymentMethod === 'cash') {
                // Efectivo: mantener la moneda seleccionada
                // Usuario debe ingresar el monto manualmente
                this.paidAmount = 0;
                this.change = 0;
                this.changePYG = 0;
            }
            this.updateTotals();
        },

        calculateChange() {
            // Solo calcular vuelto para efectivo
            if (this.paymentMethod !== 'cash') {
                this.change = 0;
                this.changePYG = 0;
                return;
            }
            
            const totalInCurrency = this.getConvertedTotal();
            
            if (this.paidAmount >= totalInCurrency) {
                this.change = this.paidAmount - totalInCurrency;
                this.changePYG = this.change * this.exchangeRates[this.currencyPaid];
            } else {
                this.change = 0;
                this.changePYG = 0;
            }
        },

        
        calculateChange() {
            // Solo calcular vuelto para efectivo
            if (this.paymentMethod !== 'cash') {
                this.change = 0;
                this.changePYG = 0;
                return;
            }
            
            const totalInCurrency = this.getConvertedTotal();
            
            if (this.paidAmount >= totalInCurrency) {
                this.change = this.paidAmount - totalInCurrency;
                this.changePYG = this.change * this.exchangeRates[this.currencyPaid];
            } else {
                this.change = 0;
                this.changePYG = 0;
            }
        },
        
        canProcessSale() {
            if (this.cart.length === 0) return false;
            
            // Validar que tenga cliente si es cr√©dito
            if (this.paymentMethod === 'credit' && !this.selectedCustomer) {
                return false;
            }
            
            if (this.paymentMethod === 'cash' || this.paymentMethod === 'pix') {
                return this.paidAmount >= this.getConvertedTotal();
            }
            
            return true;
        },
        
        clearCart() {
            if (confirm('¬øLimpiar el carrito?')) {
                this.cart = [];
                this.paidAmount = 0;
                this.change = 0;
                this.changePYG = 0;
                this.updateTotals();
            }
        },
        
        processSale() {
            if (!this.canProcessSale()) {
                alert('Complete los datos de pago');
                return;
            }
            
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url "sales:create_sale" %}';
            
            // CSRF
            this.addInput(form, 'csrfmiddlewaretoken', '{{ csrf_token }}');
            
            // Customer
            if (this.selectedCustomer) {
                this.addInput(form, 'customer_id', this.selectedCustomer);
            }
            
            // Payment data
            this.addInput(form, 'payment_method', this.paymentMethod);
            this.addInput(form, 'currency_paid', this.currencyPaid);
            
            // Total en PYG
            this.addInput(form, 'total_pyg', this.total);
            
            // Montos pagados seg√∫n moneda
            if (this.currencyPaid === 'PYG') {
                this.addInput(form, 'paid_amount_pyg', this.paidAmount);
            } else if (this.currencyPaid === 'USD') {
                this.addInput(form, 'paid_amount_usd', this.paidAmount);
            } else if (this.currencyPaid === 'BRL') {
                this.addInput(form, 'paid_amount_brl', this.paidAmount);
            }
            
            // Tasas de cambio
            this.addInput(form, 'exchange_rate_usd', this.exchangeRates.USD);
            this.addInput(form, 'exchange_rate_brl', this.exchangeRates.BRL);
            
            // Fecha prometida y cuotas (si es cr√©dito)
            if (this.paymentMethod === 'credit' && this.promisedDate) {
                this.addInput(form, 'promised_date', this.promisedDate);
            }
            if (this.paymentMethod === 'credit' && this.installments) {
                this.addInput(form, 'installments', this.installments);
            }
            
            // PIX reference
            if (this.paymentMethod === 'pix' && this.pixReference) {
                this.addInput(form, 'pix_reference', this.pixReference);
            }
            
            // Cart items
            this.cart.forEach((item) => {
                this.addInput(form, 'product_id[]', item.product.id);
                this.addInput(form, 'quantity[]', item.quantity);
                this.addInput(form, 'unit_price[]', item.unit_price);
                this.addInput(form, 'discount[]', item.discount);
            });
            
            document.body.appendChild(form);
            form.submit();
        },
        
        addInput(form, name, value) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = name;
            input.value = value;
            form.appendChild(input);
        }
    }
}
</script>
{% endblock %}
